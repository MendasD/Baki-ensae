{% extends 'chat/base2.html'%} 
{% load static %}
{% block title%} Espace de messagerie{%endblock title%}

{% block photo %}
    {% if user.utilisateur.photo %}
        <img src="{{user.utilisateur.photo.url}}" alt="Photo de profil" >
    {% endif %}
{% endblock %}

{% block email %}
    <span>{{ user.utilisateur.email }}</span>
{% endblock %}

{% block content%}

<style>

    #chat-message-submit {
            background-color: green;
            border-radius: 20%;
            color: white;
            font-weight: bold;
        }

    #espace {
        border: 1px solid;
        margin: 0 auto 5% auto;
        /* margin-bottom: 5%; */
        width: 90%;
        height: 80%;
        background-color: lightgray;
        display: flex;
        flex-direction: column;
        /* align-items: center; */
    }

    #zone-saisie{
        margin-left: 2%;
    }

</style>

<!-- le containeur "espace" est là pour contenir les messages du groupe -->
<div id="espace" class="container ">

</div>

<div id="zone-saisie">
    <input id="chat-message-input" type="text" placeholder="Entrer un message" size="70%">
    <input id="chat-message-submit" type="button" value="Send">
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    //document.querySelector('#chat-log').value = "";
    var text_box = document.getElementById('espace');

    // Stocker la date initiale
    var lastDate = "{{ message_and_event_list.0.timestamp|date:'Y-m-d' }}";
    var text_box = document.getElementById('espace');

    // Afficher la première date
    var initialDate = document.createElement('p');
    initialDate.style.color = "blue";
    initialDate.style.marginLeft = "45%";
    initialDate.textContent = lastDate;
    text_box.appendChild(initialDate);

    // On parcours les messages et évènements (join or leave) envoyés depuis la view
    {% for message_event in message_and_event_list %}

        var messageDate = "{{ message_event.timestamp|date:'Y-m-d' }}";

        if (messageDate !== lastDate) {
            lastDate = messageDate;

            var newDateElement = document.createElement('p');
            newDateElement.style.color = "blue";
            newDateElement.style.marginLeft = "45%";
            newDateElement.textContent = lastDate;
            text_box.appendChild(newDateElement);
        }

        var newDiv = document.createElement('div');
       
        newDiv.style.display = "block";
        newDiv.style.border = "1px solid lightgray";   
        newDiv.style.padding = "10px"; 
        newDiv.style.borderRadius = "7%";
        newDiv.style.marginBottom = "3%";  // Ajouter un espace entre les messages
        newDiv.style.backgroundColor = "white";
        newDiv.style.maxWidth = "55%";
        newDiv.style.minWidth = "30%";
        newDiv.style.wordWrap = "break-word"; /* Permet de passer à la ligne si le mot est trop long */
        newDiv.style.overflowWrap = "break-word"; /* Compatibilité avec certains navigateurs plus anciens */
        newDiv.style.whiteSpace = "normal"; /* Permet au texte de passer à la ligne */
        
        newDiv.className ="newmsg";

        {% if message_event.author %}

            newDiv.id = "newmessage-{{ message_event.id }}"

            var newHeader = document.createElement('h5');
            newHeader.style.color = "red";
            newHeader.textContent = "{{ message_event.author }}";

            var newContent = document.createElement('p');
            newContent.textContent = "{{ message_event.content }}";

            // Créer un conteneur Flex pour ajuster le placement de l'heure
            var timeContainer = document.createElement('div');
            timeContainer.style.display = "flex";
            timeContainer.style.justifyContent = "space-between";
            timeContainer.className = "float-end";
            
            var newhour = document.createElement('span');
            newhour.style.color = "black";
            //newhour.style.marginLeft = "75%";
            newhour.style.fontSize = "1em";
            //newhour.style.bottom = "5px";
            //newhour.style.right = "10px";
            newhour.textContent = "{{ message_event.timestamp.time }}"
            
            {% if message_event.author.username == user.username %}
                newDiv.style.backgroundColor = "#007bff";
                newContent.style.color = "white";
                //newDiv.style.marginLeft = "55%";
                newDiv.style.marginLeft = "auto";
                newDiv.style.marginRight = "2%"
                newHeader.style.display = "none";
            {% else %}
                newDiv.style.marginLeft = "2%";
                newDiv.style.marginRight = "auto";
            {% endif %}

            newDiv.appendChild(newHeader);

            // On ajoute le message auquel il repond, si ce message existe
            {% if message_event.response %}
                
                var reponseDiv = document.createElement('div');
                reponseDiv.style.display = "block";
                reponseDiv.style.border = "1px solid green";
                reponseDiv.style.padding = "10px";
                reponseDiv.style.borderRadius = "3%";
                reponseDiv.style.marginTop = "3%";
                reponseDiv.style.backgroundColor = "lightgray";
                reponseDiv.style.padding = "1%";
                reponseDiv.style.width = "80%";
                reponseDiv.style.marginLeft = "2%";

                var reponseHeader = document.createElement('h6');
                reponseHeader.style.color = "green";
                reponseHeader.textContent = "Réponse à " + "{{message_event.response.author}}";

                var reponseContent = document.createElement('p');
                reponseContent.textContent = "{{message_event.response.content}}";

                reponseDiv.appendChild(reponseHeader);
                reponseDiv.appendChild(reponseContent);

                newDiv.appendChild(reponseDiv);
            {% endif %}
            
            newDiv.appendChild(newContent);
            timeContainer.appendChild(newhour);  // Ajout de l'heure dans le conteneur
            newDiv.appendChild(timeContainer);

            var replyButton = document.createElement('button');
            replyButton.type = "button";
            replyButton.className = "repondre";
            replyButton.classList.add('col-md-2')
            replyButton.style.display = "inline";
            replyButton.style.padding = "1%";
            replyButton.style.margin = "1%";
            replyButton.style.minWidth = "30%";
            replyButton.style.maxWidth = "40%";
            replyButton.style.backgroundColor = "green";
            replyButton.style.color = "white";
            replyButton.value = "repondre";
            replyButton.style.fontSize = "14px";
            replyButton.id = "replyButton-{{message_event.id}}"; // ID unique
            replyButton.textContent = "Répondre";
            replyButton.dataset.messageId = "{{ message_event.id }}"; // Stocke l'ID du message
            replyButton.dataset.messageAuthor = "{{ message_event.author }}"
            newDiv.appendChild(replyButton);

            var deleteButton = document.createElement('button');
            deleteButton.type = "button";
            deleteButton.className = "delete";
            deleteButton.classList.add('col-md-2')
            deleteButton.style.display = "none";
            deleteButton.style.padding = "1%";
            deleteButton.style.margin = "1%";
            deleteButton.style.minWidth = "30%";
            deleteButton.style.maxWidth = "40%";
            deleteButton.style.backgroundColor = "red";
            deleteButton.style.color = "white";
            deleteButton.value = "supprimer";
            deleteButton.style.fontSize = "14px";
            deleteButton.id = "deleteButton-{{ message_event.id }}"; // ID unique
            deleteButton.textContent = "Supprimer";
            deleteButton.dataset.messageId = "{{ message_event.id }}"; // Stocke l'ID du message
            newDiv.appendChild(deleteButton);

            // on affiche les boutons de suppression si l'auteur est l'utilisateur connecté
            {% if message_event.author.username == user.username %}
                deleteButton.style.display = "inline";
            {% endif %}

            //newDiv.appendChild(newhour);
            

            text_box.appendChild(newDiv);

        {% else %}
            var newContent = document.createElement('p');
            newContent.textContent = "{{ message_event }}";
            newDiv.style.border = "none";
            newDiv.style.backgroundColor = "lightgray";
            newDiv.style.justifyContent = "center";
            newDiv.style.marginLeft = "35%";
            newDiv.style.width = "50%"
            newDiv.style.paddingLeft = "2%";
            newDiv.style.paddingRight = "2%";
            newDiv.appendChild(newContent);

            text_box.appendChild(newDiv);
        {% endif %}

    {% endfor %}

    document.addEventListener("DOMContentLoaded", function() {
        // Ajout des gestionnaires d'événements pour les boutons repondre et supprimer
        document.querySelectorAll(".repondre").forEach(button => {
            button.addEventListener("click", function() {
                var messageId = this.dataset.messageId; // Récupère l'ID du message
                var messageAuthor = this.dataset.messageAuthor;

                // On désactive le boutton 'repondre'
                this.disabled = true;

                var replyDiv = document.createElement('div');
                replyDiv.style.display = "block";
                replyDiv.style.border = "1px solid green";
                replyDiv.style.borderRadius = "1%";
                replyDiv.style.marginTop = "3%";
                replyDiv.style.backgroundColor = "lightgray";
                replyDiv.style.padding = "1%";
                replyDiv.style.width = "80%";
                replyDiv.style.marginLeft = "2%";

                var replyHeader = document.createElement('h6');
                replyHeader.style.color = "green";
                replyHeader.textContent = `Répondre à ${messageAuthor}`;

                var replyTextArea = document.createElement('input');
                replyTextArea.type = "text";
                replyTextArea.style.width = "100%";
                replyTextArea.style.height = "60%";
                replyTextArea.placeholder = "Écrire une réponse...";

                var sendReplyButton = document.createElement('button');
                sendReplyButton.type = "button";
                sendReplyButton.style.marginTop = "1%";
                sendReplyButton.style.marginRight = "3%";
                sendReplyButton.style.marginLeft = "2%";
                sendReplyButton.style.backgroundColor = "#007bff";
                sendReplyButton.style.color = "white";
                sendReplyButton.textContent = "Envoyer";

                var cancelReplyButton = document.createElement('button');
                cancelReplyButton.type = "button";
                cancelReplyButton.style.marginTop = "1%";
                cancelReplyButton.style.marginRight = "2%";
                cancelReplyButton.style.marginLeft = "auto";
                cancelReplyButton.style.backgroundColor = "gray";
                cancelReplyButton.style.color = "white";
                cancelReplyButton.textContent = "Annuler";

                sendReplyButton.addEventListener("click", function() {
                    var replyContent = replyTextArea.value;
                    if (replyContent) {
                        // Envoyer la réponse au serveur
                        chatSocket.send(JSON.stringify({
                            'type': "text_message",
                            'reponse_id': messageId,
                            'author': "{{ request.user.username }}",
                            'message': replyContent
                        }));

                       // On reactive le boutton 'repondre'. On remonte au niveau du containeur parent au container parent du bouton 'Annuler' pour chercher l'elt de classe 'repondre'
                        const repondreButton = this.parentNode.parentNode.querySelector('.repondre');
                        if (repondreButton) {
                            repondreButton.disabled = false;  // Réactiver le bouton 'repondre' spécifique
                        }
                        
                        replyDiv.remove();
                    } else {
                        alert("La réponse ne peut pas être vide.");
                    }
                });

                cancelReplyButton.addEventListener('click',function(){
                    // On reactive le boutton 'repondre'. On remonte au niveau du containeur parent au container parent du bouton 'Annuler' pour chercher l'elt de classe 'repondre'
                    const repondreButton = this.parentNode.parentNode.querySelector('.repondre');
                    if (repondreButton) {
                        repondreButton.disabled = false;  // Réactiver le bouton 'repondre' spécifique
                    }
                    replyDiv.remove();
                })

                replyDiv.appendChild(replyHeader);
                replyDiv.appendChild(replyTextArea);
                replyDiv.appendChild(sendReplyButton);
                replyDiv.appendChild(cancelReplyButton);
                this.parentNode.appendChild(replyDiv); // Ajouter le div de réponse sous le bouton
            });
        });

        document.querySelectorAll(".delete").forEach(button => {
            button.addEventListener("click", function() {
                // Suppression au niveau du front-end
                $(this).closest('.newmsg').remove();

                const messageId = this.dataset.messageId; // Récupère l'ID du message

                const data = {
                    message_id: messageId,
                };

                $.ajax({
                    url: '{% url "supprimer_message" %}',
                    type: "POST",
                    data: JSON.stringify(data),
                    contentType: "application/json",
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        alert('message supprimé avec succès!');
                    },
                    error: function(xhr, status, error) {
                        console.error('Erreur:', xhr.responseJSON ? xhr.responseJSON.error : error);
                        alert('Erreur lors de la suppression du message.');
                    }
                });

            });
        });
    });


</script>

{%endblock content%}


 
{%block script%}

<script>
    base_url = `${window.location.host}${window.location.pathname}`

    const chatSocket = new WebSocket(`ws://${base_url}`);

    chatSocket.onopen = function(e){
        console.log("connected")
    };
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus(); /* Pour mettre directement le curseur sur cet elt */
    document.querySelector('#chat-message-input').onkeyup = function(e) { /* si on appuie une touche du clavier */
    if (e.keyCode === 13) { // enter, return
        document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        const username = "{{request.user.username}}"
        chatSocket.send(JSON.stringify({
        'type':"text_message",
        "author": username,
        'message': message
        }));
        messageInputDom.value = '';
        };

    // Réception des messages provenant du serveur
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        //document.querySelector('#chat-log').value += `${data.message}\n`;
        var text_box = document.getElementById('espace');

        // bloc pour le message
        var newDiv = document.createElement('div');
        newDiv.style.display = "block";
        newDiv.style.border = "1px solid lightgray";   // Couleur douce
        newDiv.style.padding = "10px";
        newDiv.style.borderRadius = "7%";
        newDiv.style.marginBottom = "3%";  // Ajouter un espace entre les messages
        newDiv.style.backgroundColor = "white";
        newDiv.style.maxWidth = "55%";
        newDiv.style.minWidth = "30%";
        newDiv.style.wordWrap = "break-word"; /* Permet de passer à la ligne si le mot est trop long */
        newDiv.style.overflowWrap = "break-word"; /* Compatibilité avec certains navigateurs plus anciens */
        newDiv.style.whiteSpace = "normal"; /* Permet au texte de passer à la ligne */
        newDiv.className = "newmsg";

        if (data.type == "text_message") {
            if (data.author) {
                var newHeader = document.createElement('h5');
                newHeader.style.color = "red";
                newHeader.textContent = data.author;

                var newContent = document.createElement('p');
                newContent.textContent = data.content;

                var newhour = document.createElement('p');
                newhour.style.color = "black";
                newhour.style.marginLeft = "75%";
                newhour.textContent = data.heure;

                console.log(data.author);

                // Si l'utilisateur connecté est l'auteur du message
                if (data.author == "{{ user.username }}") {
                    newDiv.style.backgroundColor = "#007bff";
                    newContent.style.color = "white";
                    newDiv.style.marginLeft = "auto";
                    newDiv.style.marginRight = "2%";
                    newHeader.style.display = "none";
                } else {
                    newDiv.style.marginLeft = "2%";
                    newDiv.style.marginRight = "auto"
                }

                newDiv.appendChild(newHeader);

                // on ajoute le message auquel celui ci repond, si ce message existe

                if(data.reponse_author){
                    var reponseDiv = document.createElement('div');
                    reponseDiv.style.display = "block";
                    reponseDiv.style.border = "1px solid green";
                    reponseDiv.style.borderRadius = "1%";
                    reponseDiv.style.marginTop = "3%";
                    reponseDiv.style.backgroundColor = "lightgray";
                    reponseDiv.style.padding = "1%";
                    reponseDiv.style.width = "80%";
                    reponseDiv.style.marginLeft = "2%";

                    var reponseHeader = document.createElement('h6');
                    reponseHeader.style.color = "green";
                    reponseHeader.textContent = `Réponse à ${data.reponse_author}`;

                    var reponseContent = document.createElement('p');
                    reponseContent.textContent = data.reponse_content;

                    reponseDiv.appendChild(reponseHeader);
                    reponseDiv.appendChild(reponseContent);

                    newDiv.appendChild(reponseDiv);
                }

                newDiv.appendChild(newContent);
                
                var nbmsg = data.message_id

                newDiv.id = `newmessage-${nbmsg}`;

                var replyButton = document.createElement('button');
                replyButton.type = "button";
                replyButton.className = "repondre";
                replyButton.style.display = "inline";
                replyButton.style.padding = "1%";
                replyButton.style.margin = "1%";
                replyButton.style.backgroundColor = "green";
                replyButton.style.color = "white";
                replyButton.value = "repondre";
                replyButton.id = `replyButton-${nbmsg}`; // ID unique
                replyButton.textContent = "Répondre";
                newDiv.appendChild(replyButton);

                var deleteButton = document.createElement('button');
                deleteButton.type = "button";
                deleteButton.className = "delete";
                deleteButton.style.display = "none";
                deleteButton.style.padding = "1%";
                deleteButton.style.margin = "1%";
                deleteButton.style.backgroundColor = "red";
                deleteButton.style.color = "white";
                deleteButton.value = "supprimer";
                deleteButton.id = `deleteButton-${nbmsg}`; // ID unique
                deleteButton.textContent = "Supprimer";

                // On affiche le bouton de suppression si l'auteur est l'utilisateur connecté
                if (data.author == "{{ user.username }}") {
                    deleteButton.style.display = "inline";
                }

                newDiv.appendChild(deleteButton);

                newDiv.appendChild(newhour);
            }

            text_box.appendChild(newDiv);

            // Ajouter des gestionnaires d'événements pour les boutons
            document.getElementById(`replyButton-${nbmsg}`).addEventListener("click", function() {
                
                this.disabled = true;

                var replyDiv = document.createElement('div');
                replyDiv.style.display = "block";
                replyDiv.style.border = "1px solid green";
                replyDiv.style.borderRadius = "1%";
                replyDiv.style.marginTop = "3%";
                replyDiv.style.backgroundColor = "lightgray";
                replyDiv.style.padding = "1%";
                replyDiv.style.width = "80%";
                replyDiv.style.marginLeft = "2%";

                var replyHeader = document.createElement('h6');
                replyHeader.style.color = "green";
                replyHeader.textContent = `Répondre à ${data.author}`;

                var replyTextArea = document.createElement('input');
                replyTextArea.type = "text";
                replyTextArea.style.width = "100%";
                replyTextArea.style.height = "60%";
                replyTextArea.placeholder = "Écrire une réponse...";

                var sendReplyButton = document.createElement('button');
                sendReplyButton.type = "button";
                sendReplyButton.style.marginTop = "1%";
                sendReplyButton.style.marginRight = "5%";
                sendReplyButton.style.marginLeft = "2%";
                sendReplyButton.style.backgroundColor = "#007bff";
                sendReplyButton.style.color = "white";
                sendReplyButton.textContent = "Envoyer";

                var cancelReplyButton = document.createElement('button');
                cancelReplyButton.type = "button";
                cancelReplyButton.style.marginTop = "1%";
                cancelReplyButton.style.marginRight = "2%";
                cancelReplyButton.style.marginLeft = "auto";
                cancelReplyButton.style.backgroundColor = "gray";
                cancelReplyButton.style.color = "white";
                cancelReplyButton.textContent = "Annuler";

                // Evènement sur le boutton 'send'
                sendReplyButton.addEventListener("click", function() {
                    var replyContent = replyTextArea.value;
                    if (replyContent) {
                        // Envoyer la réponse au serveur (ce qui est traité dans le fichier consumer.py)
                        chatSocket.send(JSON.stringify({
                            //type: "reply_message",
                            'type': "text_message",
                            'reponse_id': data.message_id,
                            //reply_content: replyContent
                            'author': "{{request.user.username}}",
                            'message': replyContent
                        }));

                        // On reactive le boutton 'repondre'. On remonte au niveau du containeur parent au container parent du bouton 'Annuler' pour chercher l'elt de classe 'repondre'
                        const repondreButton = this.parentNode.parentNode.querySelector('.repondre');
                        if (repondreButton) {
                            repondreButton.disabled = false;  // Réactiver le bouton 'repondre' spécifique
                        }
                    
                        // Retirer la zone de texte de réponse après l'envoi
                        replyDiv.remove();
                        

                    } else {
                        alert("La réponse ne peut pas être vide.");
                    }
                });

                // Evènement sur le boutton 'Annuler' du bloc de réponse
                cancelReplyButton.addEventListener('click',function(){

                    // On reactive le boutton 'repondre'. On remonte au niveau du containeur parent au container parent du bouton 'Annuler' pour chercher l'elt de classe 'repondre'
                    const repondreButton = this.parentNode.parentNode.querySelector('.repondre');
                    if (repondreButton) {
                        repondreButton.disabled = false;  // Réactiver le bouton 'repondre' spécifique
                    }
                    replyDiv.remove();
                });

            
                replyDiv.appendChild(replyHeader);
                replyDiv.appendChild(replyTextArea);
                replyDiv.appendChild(sendReplyButton);
                replyDiv.appendChild(cancelReplyButton);
                newDiv.appendChild(replyDiv);
                
                
            
            });

            document.getElementById(`deleteButton-${nbmsg}`).addEventListener("click", function() {
                
                $(this).closest('.newmsg').remove(); // suppression au niveau du front-end
                const data2 = {
                    message_id: data.message_id,
                };

                $.ajax({
                    url: '{% url "supprimer_message" %}',
                    type: "POST",
                    data: JSON.stringify(data2),
                    contentType: "application/json",
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        alert('message supprimé avec succès!');
                    },
                    error: function(xhr, status, error) {
                        console.error('Erreur:', xhr.responseJSON ? xhr.responseJSON.error : error);
                        alert('Erreur lors de la suppression du message.');
                    }
                });
            });
                
        }else{
            // Si c'est plutôt un évènement (join or leave) que le chatsocket reçoit
            var newContent = document.createElement('p');
            newContent.textContent = data.message;
            newContent.style.marginLeft = "35%";

            text_box.appendChild(newContent);
        }



        status = data.status
        user = data.user
        
        if (status == "Left"){
            document.getElementById(`members-${user}`).remove()
        }else if(status == "Join"){
            var members_list = document.getElementById('members')
            var members_item = document.createElement("li")
            members_item.innerHTML = user
            members_item.setAttribute("id", `members-${user}`)
            members_list.appendChild(members_item)
        }
    };

</script>

{%endblock script%}
 